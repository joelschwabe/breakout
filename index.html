<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
    	canvas { background: #eee; display: block; margin: 0 auto; }
		.buttons { 	width :100%,
					text-align: center;
					     margin: auto;
				}
		body{
			font-weight:bold;
			font-size:large
			}
    </style>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<body>
<canvas id="myCanvas" width="1200" height="900"></canvas>
<div class="buttons">
<input type="button" onclick="startGame()" value="Start Game">
</div>
<script>
	var canvas = document.getElementById("myCanvas")
		ctx = canvas.getContext("2d"),
		paddleHeight = 15,
		paddleWidth = 150,
		paddleX = (canvas.width-paddleWidth)/2,
		rightPressed = false,
		leftPressed = false,
		paddleAccel = 0,
		score = 0,
		lives = 3,
		balls = [],
		bricks = [],
		brickWidth = 75,
		brickHeight = 20,
		brickRowCount = 3,
		brickPadding = 10,
		brickOffsetTop = 60,
		brickOffsetLeft = 30,
		brickColumnCount = Math.floor(canvas.width/(brickWidth+brickPadding) - 1),
		timer = 0;
		
	for(c=0; c<brickColumnCount; c++) {
		bricks[c] = [];
		for(r=0; r<brickRowCount; r++) {
			var hasItem = Math.floor(Math.random() * 10);
			bricks[c][r] = { x: 0, y: 0 , alive: 1, item: hasItem};
		}
	}
	
	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);
	document.addEventListener("mousemove", mouseMoveHandler, false);
	drawPaddle();
	drawBricks();
	
	function keyDownHandler(e) {
		if(e.keyCode == 39) {
			rightPressed = true;
		}
		else if(e.keyCode == 37) {
			leftPressed = true;
		}
	}
	function keyUpHandler(e) {
		if(e.keyCode == 39) {
			rightPressed = false;
		}
		else if(e.keyCode == 37) {
			leftPressed = false;
		}
	}
	
	function mouseMoveHandler(e) {
		var relativeX = e.clientX - canvas.offsetLeft;
		if(relativeX > paddleWidth/2 && relativeX < canvas.width-(paddleWidth/2)) {
			paddleX = relativeX - paddleWidth/2;
		}
	}
	
	function drawPaddle() {
		ctx.beginPath();
		ctx.rect(paddleX, canvas.height-paddleHeight-5, paddleWidth, paddleHeight);
		ctx.fillStyle = "#0095DD";
		ctx.fill();
		ctx.closePath();
	}
	
	function paddleMovements(){
		if(rightPressed && paddleX < canvas.width-paddleWidth) {
			paddleAccel += 1;
			paddleX += 7 + paddleAccel;
		}
		else if(leftPressed && paddleX > 0) {
			paddleAccel += 1;
			paddleX -= 7 + paddleAccel;
		}
		else{
			paddleAccel = 0;
		}
	}
	function drawBricks() {
		for(c=0; c<brickColumnCount; c++) {
			for(r=0; r<brickRowCount; r++) {
				if(bricks[c][r].alive == 1){
					var brickX = (c*(brickWidth+brickPadding))+brickOffsetLeft;
					var brickY = (r*(brickHeight+brickPadding))+brickOffsetTop;
					bricks[c][r].x = brickX;
					bricks[c][r].y = brickY;
					ctx.beginPath();
					ctx.rect(brickX, brickY, brickWidth, brickHeight);
					ctx.fillStyle = "#0095DD";
					ctx.fill();
					ctx.closePath();
				}
			}
		}
	}
	
	function brickCollisionDetection(ball) {
		for(c=0; c<brickColumnCount; c++) {
			for(r=0; r<brickRowCount; r++) {
				var brick = bricks[c][r];
				if(brick.alive == 1) {
					if(ball.x-ball.rad > brick.x && ball.x < brick.x+brickWidth+ball.rad && ball.y > brick.y && ball.y  < brick.y+brickHeight) {
						ball.speedy = -ball.speedy;
						brick.alive = 0;
						score += 1;
						if(brick.item == 1){
							dropBall(brick.x,brick.y);
						}
					}
				}
			}
		}
	}
	
	function wallCollisionDetection(ball, whichBall){
		if(ball.x + ball.speedx > canvas.width-ball.rad || ball.x + ball.speedx < ball.rad) {
			ball.speedx = -ball.speedx ;
		}
		if(ball.y + ball.speedy < ball.rad) {
			ball.speedy  = -ball.speedy ;
		} 
		else if(ball.y + ball.speedy > canvas.height-ball.rad) {
			if(ball.x > paddleX && ball.x < paddleX + paddleWidth + ball.rad) {
				if(ball.y = ball.y-paddleHeight){
					ball.speedy += 1;
					ball.speedx += 1;
					ball.speedy  = -ball.speedy ;
				}
			}
			else {
				if(ball.type == 0){
					lostLife();
				}
				else{
					balls.splice(whichBall,1);
				}
			}
		}
		ball.x += ball.speedx;
		ball.y += ball.speedy;
	}
	
	function drawText() {
		ctx.font = "20px Arial";
		ctx.fillStyle = "#000000";
		ctx.fillText("Score: "+score, 8, 20);
		ctx.fillText("Lives: "+lives, 8, 50);
		ctx.fillText("Breakout 2D", (canvas.width/2)-10, 20);
	}
	
	function getColor(){
		color = '#';
		for (i = 0; i < 6; i ++){
			color += randomHexVal();
		};
		return color;
	}
	function randomHexVal(){
		var ranHex = Math.floor(Math.random() * 16);
		switch(ranHex) {
			case 10:
				ranHex = 'a';
				break;
			case 11:
				ranHex = 'b';
				break;
			case 12:
				ranHex = 'c';
				break;				
			case 13:
				ranHex = 'd';
				break;	
			case 14:
				ranHex = 'e';
				break;
			case 15:
				ranHex = 'f';
				break;	
			default:
				break;
		};
		return ranHex;
	}
	
	function ball(xloc,yloc,ballRadius,xspeed,yspeed,shade,kind){
		this.x = xloc;
		this.y = yloc;
		this.rad = ballRadius;
		this.speedx = xspeed;
		this.speedy = yspeed;
		this.color = shade;
		this.type = kind;
	}

	function addBall(){
		var rad = 20;
		var xloc = canvas.width/2;
		var yloc = canvas.height - 50;
		var xspeed = Math.floor(Math.random() * 8);
		var yspeed = -7;
		var color = "#0095DD";
		var type = 0; //original ball
		var newBall = new ball(xloc,yloc,rad,xspeed,yspeed,color,type);
		balls.push(newBall);
	}
	function dropBall(xloc,yloc){
		var rad = 20;
		var xspeed = Math.floor(Math.random() * 5);
		var yspeed = 6;
		var color = getColor();
		var type = 1; //multiball
		var newBall = new ball(xloc,yloc,rad,xspeed,yspeed,color,type);
		balls.push(newBall);
	}
	function removeBalls(){
		balls = [];
	}
	
	function drawBall(ball) {
			ctx.beginPath();
			ctx.arc(ball.x, ball.y, ball.rad, 0, Math.PI*2);
			ctx.fillStyle = ball.color;
			ctx.fill();
			ctx.closePath();
	}

	function draw() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawPaddle();
		drawBricks();
		
		for (var i = 0; i < balls.length; i++){
			var ball = balls[i];
			drawBall(ball);
			brickCollisionDetection(ball);
			wallCollisionDetection(ball, i);
		}
		paddleMovements();
		if(lives < 1){
			stopGame();
		}
		drawText();
	}
	
	function startGame(){
		removeBalls();
		score = 0;
		lives = 3;
		addBall();
		timer = setInterval(function() {draw()}, 10);
		//timer = draw();
	}
	function lostLife(){
		removeBalls();
		lives--;
		addBall();
	}
	function stopGame(){
		ctx.clearRect(100, 0, canvas.width, 50);
		ctx.fillStyle = "red";
		ctx.font = "30px Arial";
		ctx.fillText("Game Over!", canvas.width/2, 30);
		clearInterval(timer);
	}
	
	function changeBackground(){
		$("#myCanvas").css({"background" : getColor()})
	}
	$(document).ready(function () {	
		$("#myCanvas").click(changeBackground);
	});
</script>
</body>
</html>
