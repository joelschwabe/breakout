<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Breakout 2D</title>
    <style>
    	canvas { background: #eee; display: block; margin: 0 auto; }
		.buttons { 	
					position: fixed;
					left: 50%;
					
				}
		body{
			font-weight:bold;
			font-size:large
			}
    </style>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	
</head>
<body>
<audio>
	<source id ="ballOut" src="sounds/ballOut.mp3" type="audio/mpeg">
	<source id ="gotPill" src="sounds/gotPill.mp3" type="audio/mpeg">
	<source id ="hitBrick" src="sounds/hitBrick.mp3" type="audio/mpeg">
	<source id ="hitWall" src="sounds/hitWall.mp3" type="audio/mpeg">
</audio>
<img id="ball0"  src="images/ball0.png"  style="display: none;"> 
<img id="ball1"  src="images/ball1.png"  style="display: none;"> 
<img id="brick0"  src="images/brick0.jpg"  style="display: none;"> 
<img id="brick1"  src="images/brick1.jpg"  style="display: none;"> 
<img id="brick2"  src="images/brick2.jpg"  style="display: none;"> 
<img id="brick3"  src="images/brick3.jpg"  style="display: none;"> 
<img id="pill0"  src="images/pill0.png"  style="display: none;"> 
<img id="pill1"  src="images/pill1.png"  style="display: none;"> 
<img id="pill2"  src="images/pill2.png"  style="display: none;"> 
<img id="pill3"  src="images/pill3.png"  style="display: none;"> 
<img id="pill4"  src="images/pill4.png"  style="display: none;"> 
<img id="paddle"  src="images/paddle.jpg"  style="display: none;"> 
<img id="level1"  src="images/1-1.jpg"  style="display: none;"> 
<canvas id="myCanvas" width="1200" height="900"></canvas>
<div class="buttons">
<input type="button" class="button" onclick="startGame(0,3,1)" value="Start Game">
</div>
<script>
	/* TO DO:
		- Fix gotPill/pillEffect (not activating)
		- Show ball before launch
		- Choose ball launch angle (may require unique draw function drawAngleArrow() \|/ )
		- Add unique levels (beyond just adding more rows eg: stars, long side columns, etc)
		- Make unique bricks active(double hitters, unbreakables, etc)
		- Hit detection on bricks (horizontal hits, edge cases)
		- Add power-ups
			- Lazer shots?
		- Add power-downs
			- Paddle Frozen
	*/
	
	var canvas = document.getElementById("myCanvas"),
		ctx = canvas.getContext("2d"),
		paddleHeight = 15,
		paddleWidth = 150,
		paddleX = (canvas.width-paddleWidth)/2,
		paddleImg = document.getElementById("paddle"),
		rightPressed = false,
		leftPressed = false,
		paddleAccel = 0,
		accelLeft = false;
		accelRight = false;
		score = 0,
		lives = 2,
		balls = [],
		bricks = [],
		pills = [],
		pillWidth = 45;
		pillHeight = 15;
		effectTimers = [],
		level1 = document.getElementById("level1"),
		sound_ballOut = document.getElementById("ballOut"),
		sound_hitBrick = document.getElementById("hitBrick"),
		sound_hitWall = document.getElementById("hitWall"),
		sound_gotPill = document.getElementById("gotPill"),
		brickWidth = 75,
		brickHeight = 25,
		brickRowCount = 3,
		brickPadding = 10,
		brickOffsetTop = 60,
		brickOffsetLeft = 30,
		brickColumnCount = Math.floor(canvas.width/(brickWidth+brickPadding) - 1),
		brickCount = 0,
		level = 1,
		timer = 0;
		
	document.addEventListener("keydown", keyDownHandler, false);
	document.addEventListener("keyup", keyUpHandler, false);
	//document.addEventListener("mousemove", mouseMoveHandler, false);
	
	function keyDownHandler(e) {
		if(e.keyCode == 39) {
			rightPressed = true;
		}
		else if(e.keyCode == 37) {
			leftPressed = true;
		}
	}
	function keyUpHandler(e) {
		if(e.keyCode == 39) {
			rightPressed = false;
		}
		else if(e.keyCode == 37) {
			leftPressed = false;
		}
	}
	/*
	function mouseMoveHandler(e) {
		var relativeX = e.clientX - canvas.offsetLeft;
		if(relativeX > paddleWidth/2 && relativeX < canvas.width-(paddleWidth/2)) {
			paddleX = relativeX - paddleWidth/2;
		}
	}
	*/
	function drawPaddle() {
		ctx.drawImage(paddleImg, paddleX,canvas.height-paddleHeight-5,paddleWidth, paddleHeight);
	}
	function paddleMovements(){
		if(rightPressed && paddleX < canvas.width-paddleWidth) {
			paddleAccel += 1;
			accelRight = true;
			accelLeft = false;
			paddleX += 7 + paddleAccel;
		}
		else if(leftPressed && paddleX > 0) {
			paddleAccel += 1;
			accelLeft = true;
			accelRight = false;
			paddleX -= 7 + paddleAccel;
		}
		else{
			if(paddleAccel > 1){
				paddleAccel--;
			}
			accelLeft = false;
			accelRight = false;
		}
	}
	
	function ball(xloc,yloc,ballRadius,xspeed,yspeed,shade,kind){
		this.rad = ballRadius;
		this.x = xloc +ballRadius;
		this.y = yloc + ballRadius;
		this.speedx = xspeed;
		this.speedy = yspeed;
		this.color = shade;
		this.type = kind;
	}
	function addBall(primary,x,y){
		var rad = 20;
		var xloc;
		var yloc;
		var xspeed;
		var yspeed;
		var color;
		var type;
		if(primary){
			xloc = canvas.width/2;
			yloc = canvas.height - 100;
			xspeed = Math.floor(Math.random() * 8);
			xspeed *= Math.floor(Math.random()*2) == 1 ? 1 : -1;
			yspeed = -6;
			color = document.getElementById("ball1"),
			type = 0; //original ball
		}
		else{
			xloc = x;
			yloc = y;
			xspeed = Math.floor(Math.random() * 5);
			xspeed *= Math.floor(Math.random()*2) == 1 ? 1 : -1;
			yspeed = 6;
			color = document.getElementById("ball0"),
			type = 1; //multiball
		}
		var newBall = new ball(xloc,yloc,rad,xspeed,yspeed,color,type);
		balls.push(newBall);
	}
	function drawBall(ball) {
		ctx.drawImage(ball.color, ball.x,ball.y,ball.rad*2, ball.rad*2);
	}
	function removeBalls(){
		balls = [];
	}
	
		
	function pill(xloc,yloc,item){
		this.x = xloc;
		this.y = yloc;
		this.type = item;
		switch(item){
			case 0:
				this.img =  document.getElementById("pill0");
				break;
			case  1:
				this.img =  document.getElementById("pill1");
				break;
			case 2:
				this.img =  document.getElementById("pill2");
				break;
			case 3:
				this.img =  document.getElementById("pill3");
				break;
			case 4:
				this.img =  document.getElementById("pill4");
				break;
			default:
				this.img =  document.getElementById("pill0");
				break;
		}
	}
	function addPill(x,y,type){
		var newPill = new pill(x,y,type);
		pills.push(newPill);
	}
	function drawPill(pill){
		ctx.drawImage(pill.img, pill.x,pill.y,pillWidth,pillHeight);
		pill.y += 8;
	}
	function gotPill(pill,pillId){
		if(pill.y + 8 > canvas.height-10) {
			if(pill.x > paddleX && pill.x < paddleX + paddleWidth) {
				if(pill.y = pill.y-paddleHeight){
					pillEffect(pill.type);
					sound_gotPill.play();
				}	
			}
			pills.splice(pillId,1);
		}
	}
	function pillEffect(type){
		switch(type) {
			case 0: //all ball speed down
				for (var i = 0; i < balls.length; i++){
					var ball = balls[i];
					if(ball.speedy > 4){
						ball.speedy -= 2;
					}
					if(ball.speedy < -4){
						ball.speedy += 2;
					}
				}
				break;
			case 1:	//all ball speed up
				for (var i = 0; i < balls.length; i++){
					var ball = balls[i];
					if(ball.speedy > 4){
						ball.speedy += 2;
					}
					if(ball.speedy < -4){
						ball.speedy -= 2;
					}
				}
				break;
			case 2: //paddle width up
				paddleWidth += 50;
				break;				
			case 3: //paddle width down
				paddleWidth -= 50;
				break;	
			case 4: //life up
				lives+=1;
				break;
			default:
				break;
		};
	}
	function removePills(){
		pills = [];
	}
	
	function brick( xloc, yloc , isAlive, whichItem,type){
		this.x = xloc;
		this.y = yloc;
		this.alive = isAlive;
		this.item = whichItem;
		switch(type){
			case 0:
				this.img =  document.getElementById("brick0");
				break;
			case  1:
				this.img =  document.getElementById("brick1");
				break;
			case 2:
				this.img =  document.getElementById("brick2");
				break;
			default:
				this.img =  document.getElementById("brick0");
				break;
		}
	}
	function setBricks(level){	
		for(c=0; c<brickColumnCount; c++) {
			bricks[c] = [];
			for(r=0; r<brickRowCount; r++) {
				brickCount++;
				var hasItem = Math.floor(Math.random() * 3);
				//var brickType = Math.floor(Math.random() * 3);
				bricks[c][r] = new brick(0,0,1,hasItem,0);
			}
		}
	}
	function drawBricks() {
		for(c=0; c<brickColumnCount; c++) {
			for(r=0; r<brickRowCount; r++) {
				if(bricks[c][r].alive == 1){
					var brickX = (c*(brickWidth+brickPadding))+brickOffsetLeft;
					var brickY = (r*(brickHeight+brickPadding))+brickOffsetTop;
					bricks[c][r].x = brickX;
					bricks[c][r].y = brickY;
					ctx.drawImage(bricks[c][r].img, brickX,brickY,brickWidth,brickHeight);
				}
			}
		}
	}
	
	function hitBrick(ball) {
		for(c=0; c<brickColumnCount; c++) {
			for(r=0; r<brickRowCount; r++) {
				var brick = bricks[c][r];
				if(brick.alive == 1) {
					if(ball.x+ball.rad > brick.x && ball.x-ball.rad < brick.x+brickWidth && ball.y-ball.rad  < brick.y+brickHeight && ball.y+ball.rad > brick.y ) {
						ball.speedy = -ball.speedy;
						brick.alive = 0;
						sound_hitBrick.play();
						score += 1;
						if(brick.item == 0){
							addBall(false,brick.x,brick.y);
						}
						if(brick.item == 1){
							var pillType = Math.floor(Math.random() * 5);
							addPill(brick.x,brick.y,pillType);
						}
						if(score == brickCount){
							stopGame(2);
						}
					}
				}
			}
		}
	}
	
	function bounceOrMove(ball, whichBall){
		if(ball.x + ball.speedx > canvas.width-ball.rad || ball.x + ball.speedx < ball.rad) {
			ball.speedx = -ball.speedx ;
		}
		if(ball.y + ball.speedy < ball.rad) {
			ball.speedy  = -ball.speedy ;
		} 
		else if(ball.y + ball.speedy > canvas.height-ball.rad*2) {
			if(ball.x > paddleX && ball.x < paddleX + paddleWidth + ball.rad) {
				if(ball.y = ball.y-paddleHeight){
					ball.speedy  = -ball.speedy ;
					if(accelLeft){
						ball.speedx = ball.speedx - paddleAccel/2;
					}
					if(accelRight){
						ball.speedx = ball.speedx + paddleAccel/2;
					}
				}
			}
			else {
				if(lives < 1 && ball.type == 0){
					stopGame(1);
				}
				else if(ball.type == 0){
					stopGame(0);
				}
				else{
					balls.splice(whichBall,1);
				}
			}
		}
		sound_hitWall.play();
		ball.x += ball.speedx;
		ball.y += ball.speedy;
	}
	/*	
	function getColor(){
		color = '#';
		for (i = 0; i < 6; i ++){
			color += randomHexVal();
		};
		return color;
	}
	function randomHexVal(){
		var ranHex = Math.floor(Math.random() * 16);
		switch(ranHex) {
			case 10:
				ranHex = 'a';
				break;
			case 11:
				ranHex = 'b';
				break;
			case 12:
				ranHex = 'c';
				break;				
			case 13:
				ranHex = 'd';
				break;	
			case 14:
				ranHex = 'e';
				break;
			case 15:
				ranHex = 'f';
				break;	
			default:
				break;
		};
		return ranHex;
	}
	*/
	function drawBackground(){
		ctx.drawImage(level1, 0,0,canvas.width,canvas.height);
	}
	function drawText() {
		ctx.font = "20px Calibri";
		ctx.fillStyle = "yellow";
		ctx.fillText("Score: "+score, 8, 20);
		ctx.fillText("Lives: "+lives, 8, 50);
		ctx.fillText("Breakout 2D", (canvas.width/2)-60, 20);
		ctx.fillText("Level:"+level, (canvas.width)-150, 20);
	}
	
	function draw(active) {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		drawBackground();
		drawPaddle();
		drawBricks();
		for (var i = 0; i < balls.length; i++){
			var ball = balls[i];
			drawBall(ball);
			if(active){
				drawText();
				hitBrick(ball);
				bounceOrMove(ball, i);
			}
		}
		for (var i = 0; i < pills.length; i++){
			var pill = pills[i];
			drawPill(pill);
			gotPill(pill,i);
		}
		paddleMovements();
	}
	
	function startGame(startingScore, startingLives, startType){
		score = startingScore;
		lives = startingLives;
		$(".button").remove();
		removeBalls();
		removePills();
		if(startType > 0){
			setBricks(startType);
		}
		addBall(true,0,0);
		timer = setInterval(function() {draw(true)}, 16);
	}

	function stopGame(outcome){
		draw(false);
		clearInterval(timer);
		if(outcome == 0){
			lives--;
			ctx.fillText("Score: "+score, 8, 20);
			ctx.fillText("Extra Lives: "+lives, 8, 50);
			ctx.fillText("Ball Out!", (canvas.width/2)-60, 30);
			$(".buttons").html('<input type="button" class="button" onclick="startGame(score,lives,0)" value="Launch Ball">');
		}
		else if(outcome == 1){
			ctx.fillStyle = "yellow";
			ctx.fillText("Score: "+score, 8, 20);
			ctx.fillText("Extra Lives: "+lives, 8, 50);	
			ctx.font = "30px Calibri";
			ctx.fillText("Game Over!", (canvas.width/2)-60, 30);
			brickCount = 0;
			score = 0;
			level = 1;
			lives = 3;
			sound_ballOut.play();
			$(".buttons").html('<input type="button" class="button" onclick="startGame(score,lives,level)" value="Start Game">');
		}
		else{
			ctx.fillText("Level Cleared!!", (canvas.width/2)-60, 30);
			brickRowCount++,
			level++;
			$(".buttons").html('<input type="button" class="button" onclick="startGame(score,lives,level)" value="Start Next Level">');
		}
	}
	//First load
	setBricks();
	brickCount = 0;
	draw(true);
	drawText();
</script>
</body>
</html>
